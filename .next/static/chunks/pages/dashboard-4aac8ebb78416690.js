(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[26],{1075:function(e,s,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/dashboard",function(){return a(2890)}])},2890:function(e,s,a){"use strict";a.r(s),a.d(s,{default:function(){return Dashboard}});var t=a(5893),n=a(7294);function TeamCreator(e){let{supabase:s,user:a,onCreated:i}=e,[r,l]=(0,n.useState)(""),[d,u]=(0,n.useState)(!1);async function createTeam(e){e.preventDefault(),u(!0);let{data:t,error:n}=await s.from("teams").insert([{name:r,host_id:a.id}]).select().single();if(u(!1),n)return alert(n.message);i(t)}return(0,t.jsxs)("form",{onSubmit:createTeam,className:"space-y-2",children:[(0,t.jsx)("label",{className:"text-sm",children:"Team name"}),(0,t.jsx)("input",{value:r,onChange:e=>l(e.target.value),className:"w-full p-2 border rounded"}),(0,t.jsx)("div",{className:"flex justify-end",children:(0,t.jsx)("button",{className:"px-3 py-1 bg-green-600 text-white rounded",disabled:d,children:"Create Team"})})]})}function TaskCreator(e){let{supabase:s,teamId:a,onCreated:i}=e,[r,l]=(0,n.useState)(""),[d,u]=(0,n.useState)(""),[c,o]=(0,n.useState)(""),[m,h]=(0,n.useState)(10);async function create(e){e.preventDefault();let{data:t,error:n}=await s.from("tasks").insert([{title:r,description:d,deadline:c||null,team_id:a,point_value:m}]).select().single();if(n)return alert(n.message);i(t),l(""),u("")}return(0,t.jsxs)("form",{onSubmit:create,className:"space-y-2",children:[(0,t.jsx)("input",{placeholder:"Title",value:r,onChange:e=>l(e.target.value),className:"w-full p-2 border rounded"}),(0,t.jsx)("textarea",{placeholder:"Description",value:d,onChange:e=>u(e.target.value),className:"w-full p-2 border rounded"}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsx)("input",{type:"datetime-local",value:c,onChange:e=>o(e.target.value),className:"p-2 border rounded"}),(0,t.jsx)("input",{type:"number",value:m,onChange:e=>h(Number(e.target.value)),className:"p-2 border rounded w-24"})]}),(0,t.jsx)("div",{className:"flex justify-end",children:(0,t.jsx)("button",{className:"px-3 py-1 bg-indigo-600 text-white rounded",children:"Create Task"})})]})}function TasksList(e){let{supabase:s,tasks:a=[],user:i,onSubmitted:r}=e,[l,d]=(0,n.useState)(null),[u,c]=(0,n.useState)(0);async function submit(e){d(e);let{data:a,error:t}=await s.from("submissions").insert([{user_id:i.id,task_id:e,score:u}]).select().single();if(d(null),t)return alert(t.message);r&&r(a)}return(0,t.jsx)("div",{className:"space-y-4",children:a.map(e=>(0,t.jsxs)("div",{className:"p-3 border rounded bg-white",children:[(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("h4",{className:"font-semibold",children:e.title}),(0,t.jsx)("p",{className:"text-sm text-gray-600",children:e.description})]}),(0,t.jsxs)("div",{className:"text-right",children:[(0,t.jsxs)("div",{className:"text-sm",children:[e.point_value," pts"]}),(0,t.jsx)("div",{className:"text-xs text-gray-500",children:e.deadline?new Date(e.deadline).toLocaleString():"No deadline"})]})]}),(0,t.jsxs)("div",{className:"mt-2 flex gap-2",children:[(0,t.jsx)("input",{type:"number",value:u,onChange:e=>c(Number(e.target.value)),className:"p-1 border rounded w-24"}),(0,t.jsx)("button",{onClick:()=>submit(e.id),disabled:l===e.id,className:"px-3 py-1 bg-green-600 text-white rounded",children:"Submit"})]})]},e.id))})}function Leaderboard(e){let{supabase:s,teamId:a}=e,[i,r]=(0,n.useState)([]);return(0,n.useEffect)(()=>{if(!a)return;let e=!0;async function load(){let{data:t}=await s.from("users").select("id,name,total_points").eq("team_id",a).order("total_points",{ascending:!1});e&&r(t||[])}load();let t=s.channel("public:users").on("postgres_changes",{event:"*",schema:"public",table:"users",filter:"team_id=eq.".concat(a)},e=>{load()}).subscribe();return()=>{e=!1,t.unsubscribe()}},[s,a]),(0,t.jsx)("div",{className:"space-y-2",children:i.map((e,s)=>(0,t.jsxs)("div",{className:"flex justify-between p-2 bg-white rounded",children:[(0,t.jsxs)("div",{children:[s+1,". ",e.name||"Anonymous"]}),(0,t.jsxs)("div",{className:"font-semibold",children:[e.total_points," pts"]})]},e.id))})}function Dashboard(e){let{supabase:s}=e,[a,i]=(0,n.useState)(null),[r,l]=(0,n.useState)(null),[d,u]=(0,n.useState)([]);async function onTaskCreated(e){u(s=>[e,...s])}async function onSubmission(e){let{data:a,error:t}=await s.from("users").select("*").eq("id",e.user_id).single();!t&&a&&await s.from("users").update({total_points:(a.total_points||0)+(e.score||0)}).eq("id",a.id)}return(0,n.useEffect)(()=>{let e=s.auth.onAuthStateChange((e,s)=>{var a;i(null!==(a=null==s?void 0:s.user)&&void 0!==a?a:null)});return(async()=>i((await s.auth.getUser()).data.user))(),()=>e.data.subscription.unsubscribe()},[s]),(0,n.useEffect)(()=>{a&&(async()=>{var e;let{data:t}=await s.from("users").select("*").eq("id",a.id).single();l(null!==(e=null==t?void 0:t.team_id)&&void 0!==e?e:null)})()},[a,s]),(0,n.useEffect)(()=>{r&&(async()=>{let{data:e}=await s.from("tasks").select("*").eq("team_id",r).order("created_at",{ascending:!1});u(e||[])})()},[r,s]),(0,t.jsx)("main",{className:"min-h-screen bg-gray-100 p-8",children:(0,t.jsxs)("div",{className:"max-w-5xl mx-auto grid grid-cols-3 gap-6",children:[(0,t.jsxs)("section",{className:"col-span-2",children:[(0,t.jsxs)("div",{className:"bg-white p-4 rounded shadow mb-4",children:[(0,t.jsx)("h3",{className:"font-semibold",children:"Your Team"}),!r&&a&&(0,t.jsx)(TeamCreator,{supabase:s,user:a,onCreated:e=>{l(e.id),s.from("users").update({team_id:e.id}).eq("id",a.id)}}),!a&&(0,t.jsx)("div",{className:"text-sm text-gray-500",children:"Sign in to create or join a team."})]}),(0,t.jsxs)("div",{className:"bg-white p-4 rounded shadow",children:[(0,t.jsx)("h3",{className:"font-semibold",children:"Create Task"}),r?(0,t.jsx)(TaskCreator,{supabase:s,teamId:r,onCreated:onTaskCreated}):(0,t.jsx)("div",{className:"text-sm text-gray-500",children:"Create or join a team to add tasks."})]}),(0,t.jsxs)("div",{className:"mt-4",children:[(0,t.jsx)("h3",{className:"mb-2",children:"Tasks"}),(0,t.jsx)(TasksList,{supabase:s,tasks:d,user:a,onSubmitted:onSubmission})]})]}),(0,t.jsx)("aside",{children:(0,t.jsxs)("div",{className:"bg-white p-4 rounded shadow",children:[(0,t.jsx)("h3",{className:"font-semibold",children:"Leaderboard"}),(0,t.jsx)(Leaderboard,{supabase:s,teamId:r})]})})]})})}}},function(e){e.O(0,[774,888,179],function(){return e(e.s=1075)}),_N_E=e.O()}]);